<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jedi Activity Game</title>
  <style>
    body,html { margin:0; padding:0; overflow:hidden; background:#111; }
    #ui {
      position: fixed; top: 10px; left: 10px;
      color: white; font-family: monospace;
      user-select: none; z-index: 10;
    }
    #ui > div { margin-bottom: 6px; }
    #instructions {
      position: absolute; top: 50%; left: 50%;
      width: 320px; margin-left: -160px; margin-top: -60px;
      color: #eee; font-family: monospace; text-align: center;
      background: rgba(0,0,0,0.7); padding: 20px; border-radius: 8px;
    }
    #newGameBtn {
      margin-top: 10px;
      padding: 4px 10px;
      background: #004400;
      border: none; color: #aaffaa;
      font-family: monospace;
      cursor: pointer;
      border-radius: 4px;
    }
  </style>
</head>
<body>
<div id="ui" style="display:none;">
  <div>Player: <span id="playerNameDisplay"></span></div>
  <div>Score: <span id="scoreValue">0</span></div>
  <div>Time Left: <span id="timeValue">60</span> sec</div>
  <div>Instructions: Complete as many Jedi actions as you can! (WASD Move, Mouse Look, Space Jump, Click to Swing)</div>
  <button id="newGameBtn">New Activity</button>
</div>
<div id="instructions">Click to Start Activity</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/PointerLockControls.js"></script>
<script>
(function(){
  var scene, camera, renderer, controls;
  var clock = new THREE.Clock();
  var player, targets = [], score = 0, timeLeft = 60, timerInterval;
  var input = { forward:false, backward:false, left:false, right:false, jump:false, swing:false, cameraYaw:0 };
  var scoreValueElem = document.getElementById('scoreValue');
  var timeValueElem = document.getElementById('timeValue');
  var instructions = document.getElementById('instructions');
  var ui = document.getElementById('ui');
  var playerNameDisplay = document.getElementById('playerNameDisplay');
  var newGameBtn = document.getElementById('newGameBtn');
  var playerName = localStorage.getItem('jediActivityPlayer') || 'Jedi';

  // Player constructor
  function Player(){
    this.group = new THREE.Group();
    var bodyGeo = new THREE.CapsuleGeometry(0.4,1.2,4,8);
    var bodyMat = new THREE.MeshStandardMaterial({color:0x2233ee});
    this.body = new THREE.Mesh(bodyGeo,bodyMat);
    this.body.castShadow = true;
    this.body.position.y=1;
    this.group.add(this.body);
    var saberGeo = new THREE.CylinderGeometry(0.04,0.04,1.8,12);
    var saberMat = new THREE.MeshStandardMaterial({color:0x00ff00,emissive:0x00ff00,emissiveIntensity:1.5});
    this.lightsaber = new THREE.Mesh(saberGeo,saberMat);
    this.lightsaber.castShadow = true;
    this.lightsaber.position.set(0.4,1.1,0);
    this.lightsaber.rotation.z = Math.PI/2;
    this.group.add(this.lightsaber);
    this.velocity = new THREE.Vector3();
    this.speed = 5;
    this.jumpVelocity = 8;
    this.gravity = -22;
    this.canJump = false;
    this.swinging = false;
    this.swingTimer = 0;
    this.swingDuration = 0.4;
    this.direction = new THREE.Vector3();
    this.group.position.set(0,0,0);
    scene.add(this.group);
  }
  Player.prototype.update = function(delta, input){
    this.direction.set(0,0,0);
    if(input.forward) this.direction.z -= 1;
    if(input.backward) this.direction.z += 1;
    if(input.left) this.direction.x -= 1;
    if(input.right) this.direction.x += 1;
    this.direction.normalize();
    if(this.direction.length() > 0){
      var angle = Math.atan2(this.direction.x,this.direction.z);
      var cameraYaw = input.cameraYaw;
      this.group.rotation.y = angle + cameraYaw;
    }
    var moveDir = new THREE.Vector3(this.direction.x,0,this.direction.z);
    moveDir.applyAxisAngle(new THREE.Vector3(0,1,0),input.cameraYaw);
    moveDir.multiplyScalar(this.speed * delta);
    this.group.position.add(moveDir);
    this.velocity.y += this.gravity * delta;
    this.group.position.y += this.velocity.y * delta;
    if(this.group.position.y < 0){
      this.group.position.y = 0;
      this.velocity.y = 0;
      this.canJump = true;
    }
    if(input.jump && this.canJump){
      this.velocity.y = this.jumpVelocity;
      this.canJump = false;
    }
    // Swing lightsaber
    if(input.swing && !this.swinging){
      this.swinging = true;
      this.swingTimer = 0;
      this.checkSwingHit();
    }
    if(this.swinging){
      this.swingTimer += delta;
      var flicker = Math.sin((this.swingTimer/this.swingDuration)*Math.PI*8)*0.5+0.5;
      this.lightsaber.material.emissiveIntensity = 1.5 + flicker;
      if(this.swingTimer >= this.swingDuration){
        this.swinging = false;
        this.lightsaber.material.emissiveIntensity = 1.5;
      }
    }
  };
  Player.prototype.checkSwingHit = function(){
    var hitRange = 2.5;
    var forward = new THREE.Vector3(0,0,-1).applyQuaternion(this.group.quaternion);
    for(var i=0; i<targets.length; i++){
      var target = targets[i];
      if(target.isHit) continue;
      var toTarget = new THREE.Vector3().subVectors(target.mesh.position,this.group.position);
      var dist = toTarget.length();
      if(dist < hitRange){
        var angle = forward.angleTo(toTarget.normalize());
        if(angle < Math.PI/4){
          target.hit();
        }
      }
    }
  };

  // Target constructor
  function Target(pos){
    var geo = new THREE.SphereGeometry(0.5,16,16);
    var mat = new THREE.MeshStandardMaterial({color:0xffd700,emissive:0xffd700,emissiveIntensity:0.7});
    this.mesh = new THREE.Mesh(geo,mat);
    this.mesh.castShadow = true;
    this.mesh.position.copy(pos);
    scene.add(this.mesh);
    this.isHit = false;
  }
  Target.prototype.hit = function(){
    if(this.isHit) return;
    this.isHit = true;
    this.mesh.visible = false;
    score += 10;
    scoreValueElem.textContent = score;
  };

  function spawnTargets(){
    // Remove old
    for(var i=0;i<targets.length;i++){
      scene.remove(targets[i].mesh);
    }
    targets = [];
    for(var i=0;i<7;i++){
      var x = Math.random()*30-15;
      var z = Math.random()*30-15;
      targets.push(new Target(new THREE.Vector3(x,0.5,z)));
    }
  }

  function startActivity(){
    score = 0;
    timeLeft = 60;
    scoreValueElem.textContent = score;
    timeValueElem.textContent = timeLeft;
    playerNameDisplay.textContent = playerName;
    ui.style.display = 'block';
    instructions.style.display = 'none';
    spawnTargets();
    if(timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(function(){
      timeLeft--;
      timeValueElem.textContent = timeLeft;
      if(timeLeft <= 0){
        clearInterval(timerInterval);
        endActivity();
      }
    },1000);
  }
  function endActivity(){
    ui.style.display = 'none';
    instructions.style.display = 'block';
    instructions.textContent = 'Activity Over! Your Score: ' + score + '\nClick to Play Again';
  }

  function initScene(){
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0a0a1a);
    camera = new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,0.1,1000);
    camera.position.set(0,1.8,5);
    renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth,window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    document.body.appendChild(renderer.domElement);
    var hemiLight = new THREE.HemisphereLight(0xffffff,0x222244,0.7);
    hemiLight.position.set(0,20,0);
    scene.add(hemiLight);
    var dirLight = new THREE.DirectionalLight(0xffffff,1);
    dirLight.position.set(5,10,7);
    dirLight.castShadow = true;
    dirLight.shadow.mapSize.width = 1024;
    dirLight.shadow.mapSize.height = 1024;
    scene.add(dirLight);
    var floorGeo = new THREE.PlaneGeometry(60,60);
    var floorMat = new THREE.MeshStandardMaterial({color:0x223322});
    var floor = new THREE.Mesh(floorGeo,floorMat);
    floor.rotation.x = -Math.PI/2;
    floor.receiveShadow = true;
    scene.add(floor);
    player = new Player();
    controls = new THREE.PointerLockControls(camera, document.body);
    scene.add(controls.getObject());
    controls.getObject().position.copy(player.group.position).add(new THREE.Vector3(0,1.5,0));
    instructions.addEventListener('click', function(){
      controls.lock();
    }, false);
    controls.addEventListener('lock', function(){
      instructions.style.display = 'none';
      ui.style.display = 'block';
    });
    controls.addEventListener('unlock', function(){
      instructions.style.display = '';
      ui.style.display = 'none';
    });
    document.addEventListener('keydown', onKeyDown);
    document.addEventListener('keyup', onKeyUp);
    document.addEventListener('mousedown', onMouseDown);
    document.addEventListener('mouseup', onMouseUp);
    document.addEventListener('mousemove', onMouseMove);
    window.addEventListener('resize', onWindowResize);
    newGameBtn.addEventListener('click', function(){
      startActivity();
    });
    playerNameDisplay.textContent = playerName;
  }
  function onKeyDown(e){
    switch(e.code){
      case 'KeyW': input.forward=true; break;
      case 'KeyS': input.backward=true; break;
      case 'KeyA': input.left=true; break;
      case 'KeyD': input.right=true; break;
      case 'Space': input.jump=true; break;
    }
  }
  function onKeyUp(e){
    switch(e.code){
      case 'KeyW': input.forward=false; break;
      case 'KeyS': input.backward=false; break;
      case 'KeyA': input.left=false; break;
      case 'KeyD': input.right=false; break;
      case 'Space': input.jump=false; break;
    }
  }
  function onMouseDown(e){
    if(e.button===0) input.swing=true;
  }
  function onMouseUp(e){
    if(e.button===0) input.swing=false;
  }
  function onMouseMove(e){
    if(!controls.isLocked) return;
    input.cameraYaw -= e.movementX * 0.002;
  }
  function onWindowResize(){
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth,window.innerHeight);
  }
  function animate(){
    requestAnimationFrame(animate);
    var delta = clock.getDelta();
    if(controls.isLocked){
      player.update(delta,input);
      controls.getObject().position.copy(player.group.position).add(new THREE.Vector3(0,1.5,0));
    }
    renderer.render(scene,camera);
  }
  initScene();
  animate();
})();
</script>
</body>
</html>
